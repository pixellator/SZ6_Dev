{% extends "base.html" %}
{% block title %}Lobby – {{ game_name }} – WSZ6 Portal{% endblock %}

{% block extra_head %}
<style>
  .lobby-wrap    { display: grid; grid-template-columns: 2fr 1fr; gap: 1rem; align-items: start; }
  .role-row      { display: flex; align-items: center; gap: .6rem; padding: .5rem 0; border-bottom: 1px solid #e0e0e0; }
  .role-name     { font-weight: 600; min-width: 120px; }
  .player-chip   { background: #d4edda; color: #155724; padding: .15rem .5rem; border-radius: 10px; font-size:.85rem; }
  .empty-slot    { color: #aaa; font-style: italic; font-size:.9rem; }
  .unassigned-list { list-style: none; }
  .unassigned-list li { padding: .35rem .5rem; background:#f0f4f8; border-radius:4px; margin-bottom:.3rem; cursor:pointer; font-size:.9rem; }
  .unassigned-list li:hover { background: #e2eaf2; }
  #status-bar    { padding: .5rem .8rem; background:#e8f4fd; border-radius:4px; font-size:.88rem; margin-bottom:.8rem; color:#0c5460; }
  .assign-hint   { font-size:.78rem; color:#666; margin-top:.4rem; }
  @media (max-width:700px) { .lobby-wrap { grid-template-columns: 1fr; } }
</style>
{% endblock %}

{% block content %}
<h1>Lobby: {{ game_name }}</h1>
<p style="color:#666; font-size:.9rem; margin-bottom:.8rem;">Session: <code>{{ session_key }}</code>
  &nbsp;|&nbsp; Share this URL with other players: <code>{{ request.build_absolute_uri }}</code></p>

<div id="status-bar">Connecting…</div>

<div class="lobby-wrap">

  <!-- Left: role table + controls -->
  <div class="card">
    <h2>Roles</h2>
    <div id="roles-container"><p style="color:#aaa;">Loading…</p></div>

    <!-- Name entry (everyone) -->
    <div style="margin-top:1rem; display:flex; gap:.5rem; align-items:center; flex-wrap:wrap;">
      <input id="name-input" type="text" placeholder="Your display name" style="max-width:200px;">
      <button class="btn btn-primary btn-sm" onclick="sendJoin()">Set name</button>
    </div>

    <!-- Start Game (owner only, shown after connected) -->
    <div id="start-section" style="display:none; margin-top:1rem;">
      <button id="start-btn" class="btn btn-success" onclick="sendStartGame()">▶ Start Game</button>
      <p class="assign-hint">Assign all required roles above before starting.</p>
    </div>
  </div>

  <!-- Right: connected/unassigned players -->
  <div class="card">
    <h2>Connected Players</h2>
    <p class="assign-hint">Click a player to select them, then click <em>Assign</em> next to a role.</p>
    <ul id="unassigned-list" class="unassigned-list">
      <li style="color:#aaa; font-style:italic;">Nobody yet</li>
    </ul>
  </div>

</div>
{% endblock %}

{% block extra_scripts %}
<script>
(function() {
  const SESSION_KEY = "{{ session_key }}";
  const WS_URL      = "{{ ws_url }}";
  const MY_USERNAME = "{{ request.user.username|escapejs }}";

  let ws            = null;
  let myToken       = null;
  let isOwner       = false;
  let selectedToken = null;
  let latestState   = null;

  // ── Connection ──────────────────────────────────────────────────

  function connect() {
    const proto = location.protocol === 'https:' ? 'wss' : 'ws';
    ws = new WebSocket(proto + '://' + location.host + WS_URL);
    ws.onopen    = () => setStatus('Connected to lobby.');
    ws.onmessage = (evt) => dispatch(JSON.parse(evt.data));
    ws.onerror   = ()  => setStatus('WebSocket error — try refreshing.');
    ws.onclose   = (e) => setStatus('Disconnected (code ' + e.code + ').');
  }

  function send(obj) {
    if (ws && ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify(obj));
  }

  // ── Message dispatch ─────────────────────────────────────────────

  function dispatch(msg) {
    if      (msg.type === 'connected')     onConnected(msg);
    else if (msg.type === 'lobby_state')   onLobbyState(msg);
    else if (msg.type === 'game_starting') onGameStarting(msg);
    else if (msg.type === 'error')         setStatus('⚠ ' + msg.message);
  }

  function onConnected(msg) {
    myToken = msg.player_token;
    isOwner = msg.is_owner;
    const nameInput = document.getElementById('name-input');
    if (!nameInput.value) { nameInput.value = MY_USERNAME; sendJoin(); }
    if (isOwner) document.getElementById('start-section').style.display = 'block';
    setStatus(isOwner ? 'You are the session owner.' : 'Waiting for owner to start…');
  }

  function onLobbyState(msg) {
    latestState = msg;
    renderRoles(msg.roles, msg.min_players_to_start);
    renderUnassigned(msg.roles.unassigned);
  }

  function onGameStarting(msg) {
    setStatus('Game is starting… redirecting.');
    if (msg.game_page_url) window.location.href = msg.game_page_url;
  }

  // ── Rendering ────────────────────────────────────────────────────

  function renderRoles(rolesData, minPlayers) {
    const el = document.getElementById('roles-container');
    if (!rolesData || !rolesData.roles) { el.innerHTML = '<p style="color:#aaa;">No roles.</p>'; return; }
    let html = '';
    for (const r of rolesData.roles) {
      const playerHtml = r.player
        ? `<span class="player-chip">${esc(r.player.name)}</span>`
        : `<span class="empty-slot">empty</span>`;
      let assignBtn = '';
      if (isOwner && selectedToken && !r.player) {
        assignBtn = `<button class="btn btn-sm btn-success" style="margin-left:.5rem;" onclick="assignRole(${r.role_num})">Assign here</button>`;
      }
      html += `<div class="role-row">
        <span class="role-name">${esc(r.name)}</span>
        ${playerHtml}${assignBtn}
        <span style="font-size:.75rem;color:#999;margin-left:auto;">${esc(r.description||'')}</span>
      </div>`;
    }
    html += `<p style="font-size:.8rem;color:#666;margin-top:.4rem;">Min. players required: <strong>${minPlayers}</strong></p>`;
    el.innerHTML = html;
  }

  function renderUnassigned(unassigned) {
    const list = document.getElementById('unassigned-list');
    if (!unassigned || unassigned.length === 0) {
      list.innerHTML = '<li style="color:#aaa;font-style:italic;">All players assigned</li>';
      return;
    }
    let html = '';
    for (const p of unassigned) {
      const sel = p.token === selectedToken;
      html += `<li style="${sel?'background:#cce5ff;font-weight:600;':''}" onclick="selectPlayer('${p.token}')">${esc(p.name)}</li>`;
    }
    list.innerHTML = html;
  }

  // ── User actions ─────────────────────────────────────────────────

  window.sendJoin = function() {
    const name = document.getElementById('name-input').value.trim();
    if (name) send({ type: 'join', name });
  };

  window.sendStartGame = function() {
    send({ type: 'start_game' });
    document.getElementById('start-btn').disabled = true;
  };

  window.selectPlayer = function(token) {
    selectedToken = (selectedToken === token) ? null : token;
    if (latestState) {
      renderRoles(latestState.roles, latestState.min_players_to_start);
      renderUnassigned(latestState.roles.unassigned);
    }
  };

  window.assignRole = function(roleNum) {
    if (!selectedToken) return;
    send({ type: 'assign_role', token: selectedToken, role_num: roleNum });
    selectedToken = null;
  };

  function setStatus(msg) { document.getElementById('status-bar').textContent = msg; }

  function esc(str) {
    const d = document.createElement('div'); d.textContent = String(str); return d.innerHTML;
  }

  connect();
})();
</script>
{% endblock %}
